<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title>L3tvia</title>
    <subtitle>Linux kenel exploitation tutorial by rona</subtitle>
    <link rel="self" type="application/atom+xml" href="https://l3tvia.rqda.wtf/atom.xml"/>
    <link rel="alternate" type="text/html" href="https://l3tvia.rqda.wtf"/>
    <generator uri="https://www.getzola.org/">Zola</generator>
    <updated>2025-12-11T15:00:00+00:00</updated>
    <id>https://l3tvia.rqda.wtf/atom.xml</id>
    <entry xml:lang="en">
        <title>XNUのpage fault handlerを読む</title>
        <published>2025-12-11T15:00:00+00:00</published>
        <updated>2025-12-11T15:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://l3tvia.rqda.wtf/coins-adc-2026/"/>
        <id>https://l3tvia.rqda.wtf/coins-adc-2026/</id>
        
        <content type="html" xml:base="https://l3tvia.rqda.wtf/coins-adc-2026/">&lt;p&gt;この記事は&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;adventar.org&#x2F;calendars&#x2F;11747&quot;&gt;coins advent calendar&lt;&#x2F;a&gt;の11日目の記事です。&lt;&#x2F;p&gt;
&lt;p&gt;10日目はベアさんの&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;qiita.com&#x2F;bear_wash&#x2F;items&#x2F;c6fc08bc8714df9d1a44&quot;&gt;会社に100万円のPCが落ちていたのでwindows消してLocalLLM構築してみた&lt;&#x2F;a&gt;でした。RTX 5000 Adaを使ってLLMを動かすのはロマンがありますね。&lt;&#x2F;p&gt;
&lt;p&gt;11日目はゃーさんの記事です。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;zhui-ji&quot;&gt;追記&lt;&#x2F;h3&gt;
&lt;p&gt;ゃーさんの記事はこちらです。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;reversed-r.dev&#x2F;articles&#x2F;2025-12-12-coins-advent-calendar-install-openmediavault-to-buffalo-linkstation-nas&#x2F;&quot;&gt;https:&#x2F;&#x2F;reversed-r.dev&#x2F;articles&#x2F;2025-12-12-coins-advent-calendar-install-openmediavault-to-buffalo-linkstation-nas&#x2F;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;以下では、xnuのversionは&lt;code&gt;xnu-11417.140.69&lt;&#x2F;code&gt;を前提とします。&lt;&#x2F;p&gt;
&lt;p&gt;このversionは&lt;code&gt;MacOS Sequoia 15.6&lt;&#x2F;code&gt;で使われています。ソースコードのダウンロードは以下から行ってください。&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;opensource.apple.com&#x2F;releases&#x2F;&quot;&gt;https:&#x2F;&#x2F;opensource.apple.com&#x2F;releases&#x2F;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple-oss-distributions&#x2F;xnu&#x2F;tree&#x2F;xnu-11417.140.69&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;apple-oss-distributions&#x2F;xnu&#x2F;tree&#x2F;xnu-11417.140.69&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;fault-handler&quot;&gt;Fault Handler&lt;&#x2F;h1&gt;
&lt;p&gt;fault handlerは、CPUが例外を起こしたときに呼ばれるOS側の処理ルーチンのことです。
このうち、page fault handlerとは、仮想アドレスは割り当てられているが、物理ページが存在しないアドレスにアクセスしたときに投げられる例外(page fault)を処理するルーチンのことです。&lt;&#x2F;p&gt;
&lt;p&gt;例えば、以下のようなコードを実行したときにpage faultが発生し、page fault handlerが呼び出されます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;#include &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;lt;sys&#x2F;mman.h&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;#include &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;lt;unistd.h&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;char&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; ptr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;mmap&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;getpagesize&lt;&#x2F;span&gt;&lt;span&gt;(), PROT_READ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; PROT_WRITE, MAP_ANON &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; MAP_PRIVATE, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;    ptr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;A&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;この例では、&lt;code&gt;mmap&lt;&#x2F;code&gt;を利用して1page分の仮想アドレスを新たに割り当てて、そのpageに&lt;code&gt;&#x27;A&#x27;&lt;&#x2F;code&gt;という文字列を書き込んでいます。
mmapを呼び出した時点では、仮想アドレスを割り当てただけで、まだ実際の物理ページ(=メモリ)は割り当てられていません。その後、&lt;code&gt;&#x27;A&#x27;&lt;&#x2F;code&gt;を書き込んだとき、すなわちpage faultが発生したときに、初めて物理メモリをこのアドレスに割り当てます。&lt;&#x2F;p&gt;
&lt;p&gt;この記事では、xnuがどのようにpage faultを処理しているかを見ていきます。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;idtnosetutoatupu&quot;&gt;IDTのセットアップ&lt;&#x2F;h2&gt;
&lt;p&gt;ユーザーランドでpage faultが発生すると、IDTを経由してkernel-landへ入ります。&lt;&#x2F;p&gt;
&lt;p&gt;IDTとは、(大雑把に言うと)ある例外が発生したときどの関数がその処理を行うかが書かれているものです。&lt;br &#x2F;&gt;
詳しくは&lt;a href=&quot;https:&#x2F;&#x2F;l3tvia.rqda.wtf&#x2F;coins-adc-2026&#x2F;%5Bhttps:&#x2F;&#x2F;wiki.osdev.org&#x2F;Interrupt_Descriptor_Table%5D&quot;&gt;https:&#x2F;&#x2F;wiki.osdev.org&#x2F;Interrupt_Descriptor_Table&lt;&#x2F;a&gt;を参照してください。&lt;&#x2F;p&gt;
&lt;p&gt;xnuのソースコードでは&lt;code&gt;osfmk&#x2F;i386&#x2F;i386_init.c&lt;&#x2F;code&gt;で初期化が行われています。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;__attribute__&lt;&#x2F;span&gt;&lt;span&gt;((noreturn))
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vstart&lt;&#x2F;span&gt;&lt;span&gt;(vm_offset_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;boot_args_start&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_desc_init&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_datap&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;));
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_desc_load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_datap&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;));
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;extern &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;unsigned&lt;&#x2F;span&gt;&lt;span&gt; mldtsz;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_desc_init&lt;&#x2F;span&gt;&lt;span&gt;(cpu_data_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;cdp&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    cpu_desc_index_t        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;cdi &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;cdp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cpu_desc_index;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(cdp &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; cpu_data_master) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;        cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtu&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;ptr  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;DBLMAP&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;uintptr_t&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;master_idt64);
&lt;&#x2F;span&gt;&lt;span&gt;        cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;ptr  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;)((&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;uintptr_t&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;master_idt64);
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cpu_desc_load&lt;&#x2F;span&gt;&lt;span&gt;(cpu_data_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;cdp)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    cpu_desc_index_t        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;cdi &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;cdp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cpu_desc_index;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;    cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;size &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x1000 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;+&lt;&#x2F;span&gt;&lt;span&gt; cdp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cpu_number;
&lt;&#x2F;span&gt;&lt;span&gt;    cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtu&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;size &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;size&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;lidt&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;uintptr_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;cdi&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cdi_idtu);
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;static inline &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;lidt&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#66d9ef;&quot;&gt;uintptr_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;desc)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;__asm__ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;volatile &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;lidt %0&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;: : &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;m&amp;quot; &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;desc));
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;vstart&lt;&#x2F;code&gt;が&lt;code&gt;cpu_desc_init&lt;&#x2F;code&gt;を呼び出して、&lt;code&gt;master_idt64&lt;&#x2F;code&gt;を&lt;code&gt;cdi-&amp;gt;cdi_idtu&lt;&#x2F;code&gt;に入れます。その後、&lt;code&gt;cpu_desc_load&lt;&#x2F;code&gt;が&lt;code&gt;cdi-&amp;gt;cdi_idtu&lt;&#x2F;code&gt;を引数に&lt;code&gt;lidt&lt;&#x2F;code&gt;を呼び出してIDTの初期化を行っています。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;master_idt64&lt;&#x2F;code&gt;の定義は以下です。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; fake_descriptor64 master_idt64[IDTSZ]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;__attribute__ &lt;&#x2F;span&gt;&lt;span&gt;((section(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;__HIB,__desc&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)))
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;__attribute__ &lt;&#x2F;span&gt;&lt;span&gt;((aligned(PAGE_SIZE))) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;#include &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;..&#x2F;x86_64&#x2F;idt_table.h&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;idt_table.h&lt;&#x2F;code&gt;の内容は以下です。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x00&lt;&#x2F;span&gt;&lt;span&gt;, idt64_zero_div)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x01&lt;&#x2F;span&gt;&lt;span&gt;, idt64_debug)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x02&lt;&#x2F;span&gt;&lt;span&gt;, idt64_nmi)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;USER_TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x03&lt;&#x2F;span&gt;&lt;span&gt;, idt64_int3)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;USER_TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x04&lt;&#x2F;span&gt;&lt;span&gt;, idt64_into)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;USER_TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x05&lt;&#x2F;span&gt;&lt;span&gt;, idt64_bounds)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x06&lt;&#x2F;span&gt;&lt;span&gt;, idt64_invop)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x07&lt;&#x2F;span&gt;&lt;span&gt;, idt64_nofpu)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x08&lt;&#x2F;span&gt;&lt;span&gt;, idt64_double_fault)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x09&lt;&#x2F;span&gt;&lt;span&gt;, idt64_fpu_over)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_ERR&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x0a&lt;&#x2F;span&gt;&lt;span&gt;, idt64_inv_tss)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x0b&lt;&#x2F;span&gt;&lt;span&gt;, idt64_segnp)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x0c&lt;&#x2F;span&gt;&lt;span&gt;, idt64_stack_fault)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_IST1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x0d&lt;&#x2F;span&gt;&lt;span&gt;, idt64_gen_prot)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TRAP_SPC&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0x0e&lt;&#x2F;span&gt;&lt;span&gt;, idt64_page_fault)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;実際に、IDT Registerの内容を読んでみると最初のentryに&lt;code&gt;idt64_zero_div&lt;&#x2F;code&gt;が入っていることがわかります。
(IDTから参照されているアドレスが&lt;code&gt;idt64_zero_div&lt;&#x2F;code&gt;そのものでないのは、&lt;code&gt;double map&lt;&#x2F;code&gt;というセキュリティ機構によるもの)&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#282a36;color:#f8f8f2;&quot;&gt;&lt;code&gt;&lt;span&gt;IDT=     fffff69bc000c000
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;(lldb) x&#x2F;8hx fffff69bc000c000
&lt;&#x2F;span&gt;&lt;span&gt;0xfffff69bc000c000: 0x2560 0x0008 0x8e00 0xc000 0xf69b 0xffff 0x0000 0x0000
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;(lldb) x&#x2F;4i fffff69bc0002560
&lt;&#x2F;span&gt;&lt;span&gt;    0xfffff69bc0002560: push   0x0
&lt;&#x2F;span&gt;&lt;span&gt;    0xfffff69bc0002562: push   0x1
&lt;&#x2F;span&gt;&lt;span&gt;    0xfffff69bc0002564: push   0x0
&lt;&#x2F;span&gt;&lt;span&gt;    0xfffff69bc0002566: jmp    0xfffff69bc00037cf
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;(lldb) disas -n idt64_zero_div
&lt;&#x2F;span&gt;&lt;span&gt;kernel`idt64_zero_div:
&lt;&#x2F;span&gt;&lt;span&gt;    0xffffff800dd02560 &amp;lt;+0&amp;gt;:  push   0x0
&lt;&#x2F;span&gt;&lt;span&gt;    0xffffff800dd02562 &amp;lt;+2&amp;gt;:  push   0x1
&lt;&#x2F;span&gt;&lt;span&gt;    0xffffff800dd02564 &amp;lt;+4&amp;gt;:  push   0x0
&lt;&#x2F;span&gt;&lt;span&gt;    0xffffff800dd02566 &amp;lt;+6&amp;gt;:  jmp    0xffffff800dd037cf ; hi64_sysenter + 31
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;user-landkarakernel-landhe&quot;&gt;user-landからkernel-landへ&lt;&#x2F;h2&gt;
&lt;p&gt;ユーザーランドでpage fualtが発生するとIDT経由で&lt;code&gt;idt64_page_fault&lt;&#x2F;code&gt;が呼び出されます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(idt64_page_fault)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	pushq	$(HNDL_ALLTRAPS)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;#if !(DEVELOPMENT || DEBUG)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	pushq	$(T_PAGE_FAULT)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;L_dispatch&lt;&#x2F;code&gt;はgsなどの設定をしたあとに、&lt;code&gt;ks_dispatch&lt;&#x2F;code&gt;を呼びます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(ks_dispatch)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	popq	%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpw	$(KERNEL64_CS)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_CS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;je	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;EXT(ks_dispatch_kernel)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov 	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_UBER_TMP
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov 	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_UBER_ISF&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;add 	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;$(ISF64_SIZE)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xchg	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Memory to memory moves (aint x86 wonderful):
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt; &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Transfer the exception frame from the per&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;CPU &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;exception stack to the
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt; &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;PCB&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;stack programmed &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;at &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cswitch.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt; &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_SS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_RSP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_RFLAGS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_CS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_RIP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_ERR(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_TRAPFN(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push 	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;ISF64_TRAPNO(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_UBER_TMP&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;EXT(ks_dispatch_user)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;ks_dispatch&lt;&#x2F;code&gt;はtrapnoなどをstackに積み、&lt;code&gt;ks_dispatch_user&lt;&#x2F;code&gt;を呼びます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(ks_dispatch_user)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpl	$(TASK_MAP_32BIT)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_TASK_MAP
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;je	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch_U32		&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;32&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bit user task &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch_U64:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	subq	$(ISS64_OFFSET)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R15(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_KERNEL_STACK&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch_64bit
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;L_dispatch_64bit&lt;&#x2F;code&gt;が呼ばれます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;*
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt; &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Here for &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;64&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bit user task &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;or &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;kernel
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt; &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch_64bit:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	movl	$(SS_64)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;SS_FLAVOR(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;*
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Save segment regs if a &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;64&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bit task has
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;installed customized segments &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;the LDT
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpl	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_CURTASK_HAS_LDT
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;je	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_skip_save_extra_segregs
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;ds&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_DS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;es&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_ES(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_skip_save_extra_segregs:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;fs&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_FS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_GS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Save general&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;purpose registers &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RAX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RBX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RCX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RDX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbp&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RBP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdi&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RDI(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsi&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RSI(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r8&lt;&#x2F;span&gt;&lt;span&gt;,  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R8(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r9&lt;&#x2F;span&gt;&lt;span&gt;,  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R9(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r10&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R10(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r11&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R11(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r12&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R12(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r13&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R13(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r14&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R14(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Zero unused GPRs. &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;BX&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;DX&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;SI &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;are clobbered elsewhere across the exception handler&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;and &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;are skipped. &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;ecx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;ecx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;edi&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;edi
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r8&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r8
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r9&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r9
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r10&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r10
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r11&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r11
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r12&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r12
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r13&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r13
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r14&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r14
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;cr2 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;is significant only for page&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;faults &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;xor	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpl	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;T_PAGE_FAULT&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_TRAPNO(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jne	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;1f
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;cr2&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_CR2(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dispatch_U64_after_fault:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_TRAPNO(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;ebx	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;ebx &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:= trapno for later &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_TRAPFN(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:= trapfn for later &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_CS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;esi	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;esi &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;cs &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;for later &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_common_dispatch
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;ここで、user-landのレジスタを退避します。その後&lt;code&gt;rdx&lt;&#x2F;code&gt;にtrapnoを入れて&lt;code&gt;L_common_dispatch&lt;&#x2F;code&gt;を呼びます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_common_dispatch:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;snip &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;66&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	leaq	EXT(idt64_hndl_table1)(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rip&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;TLB周りの処理をしたあと、&lt;code&gt;idt64_hndl_table1[trapno]&lt;&#x2F;code&gt;を呼び出します。なお、&lt;code&gt;idt64_hndl_table1&lt;&#x2F;code&gt;の定義は以下です。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;EXT(idt64_hndl_table1):
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_allintrs)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_alltraps)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_sysenter)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_syscall)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_unix_scall)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_mach_scall)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_mdep_scall)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_double_fault)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	.quad	EXT(hndl_machine_check)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;.text
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;idt64_page_fault&lt;&#x2F;code&gt;で&lt;code&gt;$(HNDL_ALLTRAPS)&lt;&#x2F;code&gt;をpushしていることからもわかる通り、page
faultの時は&lt;code&gt;hndl_all_traps&lt;&#x2F;code&gt;が呼ばれます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(hndl_alltraps)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;esi&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	testb	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;al
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jz	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;trap_from_kernel
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	TIME_TRAP_UENTRY
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Check for active vtimers &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;in &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;the current task &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_ACTIVE_THREAD&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	movl	$&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TH_IOTIER_OVERRIDE(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Reset IO tier override to &lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;before handling trap&#x2F;exception &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TH_TASK(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	TASK_VTIMER_CHECK(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	CCALL1(user_trap&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)			&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;call &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;user trap routine &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;hndl_alltraps&lt;&#x2F;code&gt;は&lt;code&gt;user_trap&lt;&#x2F;code&gt;を呼び出します。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;user-trap&quot;&gt;user_trap&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;void
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;user_trap&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	x86_saved_state_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;saved_state&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;is_saved_state64&lt;&#x2F;span&gt;&lt;span&gt;(saved_state)) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		x86_saved_state64_t     &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;regs;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		regs &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;saved_state64&lt;&#x2F;span&gt;&lt;span&gt;(saved_state);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* Record cpu where state was captured *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;		regs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;isf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;cpu &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; current_cpu;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; regs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;isf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;trapno&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;		err  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;int&lt;&#x2F;span&gt;&lt;span&gt;)regs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;isf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0xffff&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;		vaddr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;(user_addr_t)regs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;cr2;
&lt;&#x2F;span&gt;&lt;span&gt;		rip   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;(user_addr_t)regs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;isf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;rip&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;&#x2F; snip
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;switch &lt;&#x2F;span&gt;&lt;span&gt;(type) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;case&lt;&#x2F;span&gt;&lt;span&gt; T_PAGE_FAULT:
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		prot &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; VM_PROT_READ;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; T_PF_WRITE) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			prot &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;|=&lt;&#x2F;span&gt;&lt;span&gt; VM_PROT_WRITE;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;__improbable&lt;&#x2F;span&gt;&lt;span&gt;(err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; T_PF_EXECUTE)) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			prot &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;|=&lt;&#x2F;span&gt;&lt;span&gt; VM_PROT_EXECUTE;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;		kret &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault&lt;&#x2F;span&gt;&lt;span&gt;(thread&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;map,
&lt;&#x2F;span&gt;&lt;span&gt;		    vaddr,
&lt;&#x2F;span&gt;&lt;span&gt;		    prot, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;FALSE&lt;&#x2F;span&gt;&lt;span&gt;, VM_KERN_MEMORY_NONE,
&lt;&#x2F;span&gt;&lt;span&gt;		    THREAD_ABORTSAFE, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;NULL&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;__probable&lt;&#x2F;span&gt;&lt;span&gt;((kret &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; KERN_SUCCESS) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;|| &lt;&#x2F;span&gt;&lt;span&gt;(kret &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; KERN_ABORTED))) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;break&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;else if &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;__improbable&lt;&#x2F;span&gt;&lt;span&gt;(kret &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; KERN_FAILURE)) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;*
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;			 * For a user trap, vm_fault() should never return KERN_FAILURE.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;			 * If it does, we&amp;#39;re leaking preemption disables somewhere in the kernel.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;			 *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;panic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;vm_fault() KERN_FAILURE from user fault on thread &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;%p&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, thread);
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* PAL debug hook (empty on x86) *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;pal_dbg_page_fault&lt;&#x2F;span&gt;&lt;span&gt;(thread, vaddr, kret);
&lt;&#x2F;span&gt;&lt;span&gt;		exc &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; EXC_BAD_ACCESS;
&lt;&#x2F;span&gt;&lt;span&gt;		code &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; kret;
&lt;&#x2F;span&gt;&lt;span&gt;		subcode &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; vaddr;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;break&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;user_trap&lt;&#x2F;code&gt;はstackに積まれた&lt;code&gt;saved_state&lt;&#x2F;code&gt;をみて、例外の種類でswitchを行います。&lt;&#x2F;p&gt;
&lt;p&gt;page faultの場合は、&lt;code&gt;T_PAGE_FAULT&lt;&#x2F;code&gt;です。その後、引数の設定を行って&lt;code&gt;vm_fault&lt;&#x2F;code&gt;を呼びます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;kern_return_t
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_t        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_offset_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;vaddr&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_prot_t       &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;fault_type&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	boolean_t       &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;change_wiring&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_tag_t        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;wire_tag&lt;&#x2F;span&gt;&lt;span&gt;,               &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* if wiring must pass tag != VM_KERN_MEMORY_NONE *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;int             &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;interruptible&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	pmap_t          &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;caller_pmap&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_offset_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;caller_pmap_addr&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; vm_object_fault_info fault_info &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;interruptible &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; interruptible,
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;fi_change_wiring &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; change_wiring,
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault_internal&lt;&#x2F;span&gt;&lt;span&gt;(map, vaddr, fault_type, wire_tag,
&lt;&#x2F;span&gt;&lt;span&gt;	           caller_pmap, caller_pmap_addr,
&lt;&#x2F;span&gt;&lt;span&gt;	           &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;NULL&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;fault_info);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;vm_fault_internal&lt;&#x2F;code&gt;が呼ばれます。ここでpage fault handlerのメインの処理が行われます(2400行あります)。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;vm-fault-internal&quot;&gt;vm_fault_internal&lt;&#x2F;h2&gt;
&lt;p&gt;xnuのメモリ管理については、&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;papers.put.as&#x2F;papers&#x2F;macosx&#x2F;2019&#x2F;OBTS_v2_Beer.pdf&quot;&gt;@i41nbeer氏のこのスライド&lt;&#x2F;a&gt;が詳しいです。&lt;&#x2F;p&gt;
&lt;p&gt;正確性を犠牲にして雑にいうならば、&lt;code&gt;vm_map_t&lt;&#x2F;code&gt;が仮想アドレス空間全体、&lt;code&gt;vm_map_entry_t&lt;&#x2F;code&gt;が連続した仮想アドレス空間、&lt;code&gt;pmap_t&lt;&#x2F;code&gt;がページテーブルを表します。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;kern_return_t
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault_internal&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_t           &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_offset_t    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;vaddr&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_prot_t          &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;caller_prot&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_tag_t           &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;wire_tag&lt;&#x2F;span&gt;&lt;span&gt;,               &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* if wiring must pass tag != VM_KERN_MEMORY_NONE *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	pmap_t             &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;caller_pmap&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_offset_t    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;caller_pmap_addr&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	ppnum_t            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;physpage_p&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_object_fault_info_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;fault_info&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;関数定義はこのようになっています。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;	kr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_map_lookup_and_lock_object&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;map, vaddr,
&lt;&#x2F;span&gt;&lt;span&gt;	    (fault_type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span&gt;(need_copy &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt; VM_PROT_COPY &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)),
&lt;&#x2F;span&gt;&lt;span&gt;	    object_lock_type, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;version,
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;object, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;offset, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;prot, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;wired,
&lt;&#x2F;span&gt;&lt;span&gt;	    fault_info,
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;real_map,
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;object_is_contended);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;様々なassertをしたあと、&lt;code&gt;vm_map_lookup_and_lock_object&lt;&#x2F;code&gt;が呼ばれます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;kern_return_t
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_map_lookup_and_lock_object&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_t                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;var_map&lt;&#x2F;span&gt;&lt;span&gt;,       &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* IN&#x2F;OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_offset_t         &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;vaddr&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_prot_t               &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;fault_type&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;int                     &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;object_lock_type&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_version_t        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;out_version&lt;&#x2F;span&gt;&lt;span&gt;,   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_object_t             &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;object&lt;&#x2F;span&gt;&lt;span&gt;,        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_object_offset_t      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span&gt;,        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_prot_t               &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;out_prot&lt;&#x2F;span&gt;&lt;span&gt;,      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	boolean_t               &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;wired&lt;&#x2F;span&gt;&lt;span&gt;,         &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_object_fault_info_t  &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;fault_info&lt;&#x2F;span&gt;&lt;span&gt;,     &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_t                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;real_map&lt;&#x2F;span&gt;&lt;span&gt;,      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;bool                    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;contended&lt;&#x2F;span&gt;&lt;span&gt;)     &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* OUT *&#x2F;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;この関数は&lt;code&gt;var_map&lt;&#x2F;code&gt;の&lt;code&gt;vaddr&lt;&#x2F;code&gt;に一致するアドレス空間の様々なデータを返します。&lt;&#x2F;p&gt;
&lt;p&gt;長くなるので省略しますが、最終的にこの関数は&lt;code&gt;vm_map_store_lookup_entry_rb&lt;&#x2F;code&gt;を呼び出して、&lt;code&gt;var_map&lt;&#x2F;code&gt;が管理するRB
treeから&lt;code&gt;vm_map_entry_t&lt;&#x2F;code&gt;を取得してきて、そこから種々の情報を取得します。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;bool
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_map_store_lookup_entry_rb&lt;&#x2F;span&gt;&lt;span&gt;(vm_map_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;, vm_map_offset_t &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;address&lt;&#x2F;span&gt;&lt;span&gt;, vm_map_entry_t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;vm_entry&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; vm_map_header &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;hdr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;map&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;hdr;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; vm_map_store  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;rb_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;RB_ROOT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;hdr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;rb_head_store);
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_entry_t       cur &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_map_to_entry&lt;&#x2F;span&gt;&lt;span&gt;(map);
&lt;&#x2F;span&gt;&lt;span&gt;	vm_map_entry_t       prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; VM_MAP_ENTRY_NULL;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;while &lt;&#x2F;span&gt;&lt;span&gt;(rb_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;!= &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#8be9fd;&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; vm_map_store&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;NULL&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		cur &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;VME_FOR_STORE&lt;&#x2F;span&gt;&lt;span&gt;(rb_entry);
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(address &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;gt;=&lt;&#x2F;span&gt;&lt;span&gt; cur&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;vme_start) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(address &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt; cur&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;vme_end) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;vm_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; cur;
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;TRUE&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;			rb_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;RB_RIGHT&lt;&#x2F;span&gt;&lt;span&gt;(rb_entry, entry);
&lt;&#x2F;span&gt;&lt;span&gt;			prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; cur;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;else &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			rb_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;RB_LEFT&lt;&#x2F;span&gt;&lt;span&gt;(rb_entry, entry);
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; VM_MAP_ENTRY_NULL) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_map_to_entry&lt;&#x2F;span&gt;&lt;span&gt;(map);
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;vm_entry &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; prev;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;FALSE&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;その後、&lt;code&gt;vm_fault_page&lt;&#x2F;code&gt;を呼び出して、pageをinsertします。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;	vm_fault_return_t err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault_page&lt;&#x2F;span&gt;&lt;span&gt;(object, offset, fault_type,
&lt;&#x2F;span&gt;&lt;span&gt;	    (fault_info&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;fi_change_wiring &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&amp;amp; !&lt;&#x2F;span&gt;&lt;span&gt;wired),
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;FALSE&lt;&#x2F;span&gt;&lt;span&gt;,                &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;&#x2F;* page not looked up *&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;prot, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;result_page, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;top_page,
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;type_of_fault,
&lt;&#x2F;span&gt;&lt;span&gt;	    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;error_code, map&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;no_zero_fill,
&lt;&#x2F;span&gt;&lt;span&gt;	    fault_info);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;c&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-c &quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span&gt;			m &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_page_grab_options&lt;&#x2F;span&gt;&lt;span&gt;(grab_options);
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(m &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; VM_PAGE_NULL) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_fault_cleanup&lt;&#x2F;span&gt;&lt;span&gt;(object, first_m);
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;thread_interrupt_level&lt;&#x2F;span&gt;&lt;span&gt;(interruptible_state);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;return&lt;&#x2F;span&gt;&lt;span&gt; VM_FAULT_MEMORY_SHORTAGE;
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;(fault_info &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; fault_info&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;batch_pmap_op &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;TRUE&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_page_insert_internal&lt;&#x2F;span&gt;&lt;span&gt;(m, object,
&lt;&#x2F;span&gt;&lt;span&gt;				    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_object_trunc_page&lt;&#x2F;span&gt;&lt;span&gt;(offset),
&lt;&#x2F;span&gt;&lt;span&gt;				    VM_KERN_MEMORY_NONE, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;FALSE&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;TRUE&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;TRUE&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;FALSE&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;NULL&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;else &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_page_insert&lt;&#x2F;span&gt;&lt;span&gt;(m, object, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;vm_object_trunc_page&lt;&#x2F;span&gt;&lt;span&gt;(offset));
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;この後、様々な後処理をして&lt;code&gt;hndl_alltraps&lt;&#x2F;code&gt;に戻ります(長いので割愛)。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;kernel-landkarauser-landhe&quot;&gt;kernel-landからuser-landへ&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;hndl_alltraps&lt;&#x2F;code&gt;に戻ってきたあと、&lt;code&gt;return_from_traps&lt;&#x2F;code&gt;へ進みます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(return_from_trap)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;movq	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_ACTIVE_THREAD&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Get current thread &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	movl	$&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TH_IOTIER_OVERRIDE(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Reset IO tier override to &lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;1 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;before returning to userspace &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;movq	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TH_PCB_ISS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;PCB stack &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	movl	%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_PENDING_AST&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	testl	%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;je	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;EXT(return_to_user)		&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;branch if no AST &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(ret_to_user)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_ACTIVE_THREAD&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpq	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;TH_PCB_IDS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Is there a debug register context? &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jnz	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_dr_restore_island
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_post_dr_restore:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;*
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;We now mark the task&amp;#39;s address space as active for TLB coherency.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Handle special cases such as pagezero&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;less tasks here.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_TASK_CR3&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_ACTIVE_CR3
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpl	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_PAGEZERO_MAPPED
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jnz	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_cr3_switch_island
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	movl	EXT(no_shared_cr3)(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rip&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;test	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;eax		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* -&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;no_shared_cr3 &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jnz	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_cr3_switch_island
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;    L_cr3_switch_return:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_DR7&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Is there a debug control register?&lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;cmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;je	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;4f
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;dr7		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Set &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;DR7 &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;movq	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_DR7
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpl	$(SS_64)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;SS_FLAVOR(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;64&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bit state? &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jne	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_32bit_return
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;*
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Restore general &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;64&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bit registers.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Here on fault stack &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;and &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;PCB address &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;in &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;R15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	 &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	leaq	EXT(idt64_hndl_table0)(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rip&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;ks_64bit_return&lt;&#x2F;code&gt;が呼ばれます。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;asm&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-asm &quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Entry(ks_64bit_return)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R14(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r14
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R13(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r13
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R12(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r12
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R11(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r11
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R10(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r10
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R9(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;,  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r9
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R8(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;,  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r8
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RSI(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsi
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RDI(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdi
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RBP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbp
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RDX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rdx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RCX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rcx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RBX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rbx
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RAX(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rax
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Switch to per&lt;&#x2F;span&gt;&lt;span&gt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;CPU &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;exception stack &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;gs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;:CPU_ESTACK&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Synthesize interrupt stack frame from PCB savearea to exception stack &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_SS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RSP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RFLAGS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_CS(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;push	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_RIP(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	cmpw	$(KERNEL64_CS)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bd93f9;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;rsp&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jne	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;1f			&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Returning to user (%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;will be restored after the segment checks) &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;mov	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;R64_R15(%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;r15
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;jmp	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_64b_kernel_return	&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;Returning to kernel &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;L_64b_kernel_return:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;.globl EXT(ret64_iret)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;EXT(ret64_iret):
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;iretq			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;return from interrupt &lt;&#x2F;span&gt;&lt;span&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;&#x2F;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;iret&lt;&#x2F;code&gt;が呼ばれて、無事user-landへ帰還できます。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;owarini&quot;&gt;おわりに&lt;&#x2F;h1&gt;
&lt;p&gt;あまりメモリ管理の本質的なところに全然触れられなかった...。&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>How to Build Android 15 arm64 for QEMU</title>
        <published>2025-02-19T12:00:00+00:00</published>
        <updated>2025-02-19T12:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://l3tvia.rqda.wtf/build-aosp/"/>
        <id>https://l3tvia.rqda.wtf/build-aosp/</id>
        
        <content type="html" xml:base="https://l3tvia.rqda.wtf/build-aosp/">&lt;h1 id=&quot;sosukodowoqu-de&quot;&gt;ソースコードを取得&lt;&#x2F;h1&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;mkdir&lt;&#x2F;span&gt;&lt;span&gt; android &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; android
&lt;&#x2F;span&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;repo&lt;&#x2F;span&gt;&lt;span&gt; init&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -u&lt;&#x2F;span&gt;&lt;span&gt; https:&#x2F;&#x2F;android.googlesource.com&#x2F;kernel&#x2F;manifest&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -b&lt;&#x2F;span&gt;&lt;span&gt; common-android15-6.6-lts
&lt;&#x2F;span&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;repo&lt;&#x2F;span&gt;&lt;span&gt; sync&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -c -d -j&lt;&#x2F;span&gt;&lt;span&gt;`&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;nproc&lt;&#x2F;span&gt;&lt;span&gt;`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;sosukodogai-bian&quot;&gt;ソースコード改変&lt;&#x2F;h1&gt;
&lt;p&gt;必要なLKMをkernel本体にくっつける作業&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;diff&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-diff &quot;&gt;&lt;code class=&quot;language-diff&quot; data-lang=&quot;diff&quot;&gt;&lt;span&gt;diff --git a&#x2F;arch&#x2F;arm64&#x2F;configs&#x2F;gki_defconfig b&#x2F;arch&#x2F;arm64&#x2F;configs&#x2F;gki_defconfig
&lt;&#x2F;span&gt;&lt;span&gt;index e4a6cfe6fa5b..260082894c00 100644
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;--- a&#x2F;arch&#x2F;arm64&#x2F;configs&#x2F;gki_defconfig
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;+++ b&#x2F;arch&#x2F;arm64&#x2F;configs&#x2F;gki_defconfig
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -785,3 +785,19 @@ CONFIG_KUNIT_TEST=m
&lt;&#x2F;span&gt;&lt;span&gt; CONFIG_KUNIT_EXAMPLE_TEST=m
&lt;&#x2F;span&gt;&lt;span&gt; # CONFIG_KUNIT_DEFAULT_ENABLED is not set
&lt;&#x2F;span&gt;&lt;span&gt; # CONFIG_RUNTIME_TESTING_MENU is not set
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_PTP_1588_CLOCK=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_E1000=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_E1000E=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_VIRTIO_PCI=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_VIRTIO_BALLOON=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_VIRTIO_BLK=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_VIRTIO_NET=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_9P_FS_SECURITY=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_NET_9P=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_NET_9P_VIRTIO=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_NET_9P_DEBUG=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_9P_FS=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_9P_FS_POSIX_ACL=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_DEVTMPFS=y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+CONFIG_DEVTMPFS_MOUNT=y
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;build.config.gki b&#x2F;build.config.gki
&lt;&#x2F;span&gt;&lt;span&gt;index 4b931d9eb333..da87a30d24e8 100644
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;--- a&#x2F;build.config.gki
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;+++ b&#x2F;build.config.gki
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -1,2 +1,2 @@
&lt;&#x2F;span&gt;&lt;span&gt; DEFCONFIG=gki_defconfig
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-POST_DEFCONFIG_CMDS=&amp;quot;check_defconfig&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+###POST_DEFCONFIG_CMDS=&amp;quot;check_defconfig&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;diff --git a&#x2F;modules.bzl b&#x2F;modules.bzl
&lt;&#x2F;span&gt;&lt;span&gt;index c93be156738d..9ad3e7624c74 100644
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;--- a&#x2F;modules.bzl
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;+++ b&#x2F;modules.bzl
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -8,7 +8,7 @@ This module contains a full list of kernel modules
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt; _COMMON_GKI_MODULES_LIST = [
&lt;&#x2F;span&gt;&lt;span&gt;     # keep sorted
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;block&#x2F;virtio_blk.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;block&#x2F;virtio_blk.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;block&#x2F;zram&#x2F;zram.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;bluetooth&#x2F;btbcm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;bluetooth&#x2F;btqca.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -39,16 +39,16 @@ _COMMON_GKI_MODULES_LIST = [
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;net&#x2F;usb&#x2F;rtl8150.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;net&#x2F;usb&#x2F;usbnet.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;net&#x2F;wwan&#x2F;wwan.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;pps&#x2F;pps_core.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;ptp&#x2F;ptp.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;pps&#x2F;pps_core.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;ptp&#x2F;ptp.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;usb&#x2F;class&#x2F;cdc-acm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;usb&#x2F;mon&#x2F;usbmon.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;usb&#x2F;serial&#x2F;ftdi_sio.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;usb&#x2F;serial&#x2F;usbserial.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;virtio&#x2F;virtio_balloon.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci_legacy_dev.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci_modern_dev.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;virtio&#x2F;virtio_balloon.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci_legacy_dev.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;virtio&#x2F;virtio_pci_modern_dev.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;kernel&#x2F;kheaders.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;lib&#x2F;crypto&#x2F;libarc4.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;mm&#x2F;zsmalloc.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -61,8 +61,8 @@ _COMMON_GKI_MODULES_LIST = [
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;6lowpan&#x2F;nhc_routing.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;6lowpan&#x2F;nhc_udp.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;8021q&#x2F;8021q.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;net&#x2F;9p&#x2F;9pnet.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;net&#x2F;9p&#x2F;9pnet_fd.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;net&#x2F;9p&#x2F;9pnet.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;net&#x2F;9p&#x2F;9pnet_fd.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;bluetooth&#x2F;bluetooth.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;bluetooth&#x2F;hidp&#x2F;hidp.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;net&#x2F;bluetooth&#x2F;rfcomm&#x2F;rfcomm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;@@ -97,7 +97,7 @@ _ARM64_GKI_MODULES_LIST = [
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;arch&#x2F;arm64&#x2F;geniezone&#x2F;gzvm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;char&#x2F;hw_random&#x2F;cctrng.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span&gt;     &amp;quot;drivers&#x2F;misc&#x2F;open-dice.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;-    &amp;quot;drivers&#x2F;ptp&#x2F;ptp_kvm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+    # &amp;quot;drivers&#x2F;ptp&#x2F;ptp_kvm.ko&amp;quot;,
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;build&quot;&gt;Build&lt;&#x2F;h1&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;tools&#x2F;bazel&lt;&#x2F;span&gt;&lt;span&gt; run &#x2F;&#x2F;common:kernel_aarch64_dist
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;create-rootfs&quot;&gt;Create rootfs&lt;&#x2F;h1&gt;
&lt;p&gt;&lt;strong&gt;WIP&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;h1 id=&quot;boot&quot;&gt;Boot&lt;&#x2F;h1&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;qemu-system-aarch64 &lt;&#x2F;span&gt;&lt;span&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -m&lt;&#x2F;span&gt;&lt;span&gt; 2048 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -smp&lt;&#x2F;span&gt;&lt;span&gt; 2 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -machine&lt;&#x2F;span&gt;&lt;span&gt; virt \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -cpu&lt;&#x2F;span&gt;&lt;span&gt; cortex-a57 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -display&lt;&#x2F;span&gt;&lt;span&gt; none \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -serial&lt;&#x2F;span&gt;&lt;span&gt; stdio \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -no-reboot &lt;&#x2F;span&gt;&lt;span&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -device&lt;&#x2F;span&gt;&lt;span&gt; virtio-rng-pci \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -cpu&lt;&#x2F;span&gt;&lt;span&gt; coretex-a57 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -device&lt;&#x2F;span&gt;&lt;span&gt; e1000,netdev=net0 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -netdev&lt;&#x2F;span&gt;&lt;span&gt; user,id=net0,restrict=on,hostfwd=tcp::20022-:22 \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -drive&lt;&#x2F;span&gt;&lt;span&gt; file=.&#x2F;rootfs.ext2,if=virtio,format=raw,cache=none \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -snapshot &lt;&#x2F;span&gt;&lt;span&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -kernel&lt;&#x2F;span&gt;&lt;span&gt; .&#x2F;Image \
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;        -append &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;rdinit=&#x2F;linuxrc console=ttyAMA0 root=&#x2F;dev&#x2F;vda verbose&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>WORD56号</title>
        <published>2024-10-18T05:00:00+00:00</published>
        <updated>2024-10-18T05:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://l3tvia.rqda.wtf/book56/"/>
        <id>https://l3tvia.rqda.wtf/book56/</id>
        
        <content type="html" xml:base="https://l3tvia.rqda.wtf/book56/">&lt;h1 id=&quot;kontentuyi-lan&quot;&gt;コンテンツ一覧&lt;&#x2F;h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;drive.proton.me&#x2F;urls&#x2F;524KN0JS58#Dr212Euef2nX&quot;&gt;book56.tar.gz&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;paste.c-net.org&#x2F;HeineVirginia&quot;&gt;コマンドコピペ用URL&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;jie-shuo&quot;&gt;解説&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;mod-probeshu-kihuan-e&quot;&gt;mod_probe書き換え&lt;&#x2F;h2&gt;
&lt;p&gt;To be added...&lt;&#x2F;p&gt;
&lt;h2 id=&quot;task-structshu-kihuan-e&quot;&gt;task_struct書き換え&lt;&#x2F;h2&gt;
&lt;p&gt;To be added...&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Kernel Exploit環境構築</title>
        <published>2024-10-17T15:00:00+00:00</published>
        <updated>2024-10-17T15:00:00+00:00</updated>
        
        <author>
          <name>
            
              Unknown
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://l3tvia.rqda.wtf/build/"/>
        <id>https://l3tvia.rqda.wtf/build/</id>
        
        <content type="html" xml:base="https://l3tvia.rqda.wtf/build/">&lt;h2 id=&quot;xiang-ding-huan-jing&quot;&gt;想定環境&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;OS: Ubuntu 22.04&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;kanerunobirudotososukodorideingunohuan-jing-zheng-bei&quot;&gt;カーネルのビルドとソースコードリーディングの環境整備&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;gccwozui-xin-nisuru&quot;&gt;GCCを最新にする&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; add-apt-repository ppa:ubuntu-toolchain-r&#x2F;test
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; apt-get update
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; apt-get install gcc-13 g++-13
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; update-alternatives&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; --install&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;usr&#x2F;bin&#x2F;gcc gcc &#x2F;usr&#x2F;bin&#x2F;gcc-13 100&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; --slave&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;usr&#x2F;bin&#x2F;g++ g++ &#x2F;usr&#x2F;bin&#x2F;g++-13
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;ti-gong-huairunobaziyonque-ren&quot;&gt;提供ファイルのバージョン確認&lt;&#x2F;h3&gt;
&lt;p&gt;以下を実行しカーネルのバージョンを特定する&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;path&#x2F;to&#x2F;ctf
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;strings&lt;&#x2F;span&gt;&lt;span&gt; bzImage &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;grep&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -E &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;[0-9]+\.[0-9]+\.[0-9]+&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;linuxsosunoclone&quot;&gt;Linuxソースのclone&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;git&lt;&#x2F;span&gt;&lt;span&gt; clone https:&#x2F;&#x2F;github.com&#x2F;gregkh&#x2F;linux.git&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -b&lt;&#x2F;span&gt;&lt;span&gt; linux-6.6.y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; linux
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;git&lt;&#x2F;span&gt;&lt;span&gt; fetch&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; --tags&lt;&#x2F;span&gt;&lt;span&gt; origin linux-6.6.y:linux-6.6.y
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;git&lt;&#x2F;span&gt;&lt;span&gt; checkout v6.6.77
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;debatugusinboruwotuketebirudo&quot;&gt;デバッグシンボルをつけてビルド&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;# 依存パッケージのインストール
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; apt install libncurses-dev gawk flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf llvm bear dwarves cpio bc
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h4 id=&quot;dehuorutodebirudosuruchang-he&quot;&gt;- デフォルトでビルドする場合&lt;&#x2F;h4&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt; alldefconfig &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt; menuconfig
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h4 id=&quot;confighuairugati-gong-sareteiruchang-he&quot;&gt;- configファイルが提供されている場合&lt;&#x2F;h4&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;cp&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;path&#x2F;to&#x2F;ctf&#x2F;config .config
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt; olddefconfig &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt; menuconfig
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;以下のコンフィグをオンにする&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;CONFIG_8250&lt;&#x2F;code&gt;,&lt;code&gt;CONFIG_8250_CONSOLE&lt;&#x2F;code&gt;: ログを出力させるために必要&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_BLK_DEV_INITRD&lt;&#x2F;code&gt;: rootfs(initramfs)のマウントに必要&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_DEVTMPFS&lt;&#x2F;code&gt;,&lt;code&gt;CONFIG_DEVTMPFS_MOUNT&lt;&#x2F;code&gt;: &#x2F;devの自動マウント&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT&lt;&#x2F;code&gt;: シンボル付きvmlinuxを吐く&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_BINFMT_SCRIPT&lt;&#x2F;code&gt;,&lt;code&gt;CONFIG_BINFMT_MISC&lt;&#x2F;code&gt;: エクスプロイトでよく使うmodprobeを有効化&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;ビルド(5分くらいかかる)&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;bear&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt; --&lt;&#x2F;span&gt;&lt;span&gt; make -j$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;nproc&lt;&#x2F;span&gt;&lt;span&gt;) bzImage vmlinux
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;&#x2F;vmlinux&lt;&#x2F;code&gt;がデバッグシンボル付きのカーネルイメージで&lt;code&gt;&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage&lt;&#x2F;code&gt;がカーネルなのでこれを問題ファイルにコピー&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;mv&lt;&#x2F;span&gt;&lt;span&gt; vmlinux &#x2F;path&#x2F;to&#x2F;ctf&#x2F;vmlinux.own
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;mv&lt;&#x2F;span&gt;&lt;span&gt; bzImage &#x2F;path&#x2F;to&#x2F;ctf&#x2F;bzImage.own
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;sosukodorideingu&quot;&gt;ソースコードリーディング&lt;&#x2F;h3&gt;
&lt;h4 id=&quot;clionnochang-he&quot;&gt;- CLionの場合&lt;&#x2F;h4&gt;
&lt;ol&gt;
&lt;li&gt;初期画面からopenを選択&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;compile_commands.json&lt;&#x2F;code&gt;を選択&lt;&#x2F;li&gt;
&lt;li&gt;Open as Projectを選択&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h4 id=&quot;vscodenochang-he&quot;&gt;- VSCodeの場合&lt;&#x2F;h4&gt;
&lt;p&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;p3land.smallkirby.com&#x2F;kernel&#x2F;prepare&quot;&gt;https:&#x2F;&#x2F;p3land.smallkirby.com&#x2F;kernel&#x2F;prepare&lt;&#x2F;a&gt; を読むといいらしい(VSCodeを使ってないので詳しくはわからない)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;turulei-noinsutoru&quot;&gt;ツール類のインストール&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;lysithea&quot;&gt;lysithea&lt;&#x2F;h3&gt;
&lt;p&gt;お好きな場所で&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;git&lt;&#x2F;span&gt;&lt;span&gt; clone git@github.com:smallkirby&#x2F;lysithea.git
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;vermagic&quot;&gt;vermagic&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;git@github.com:yaxinsn&#x2F;vermagic.git
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; vermagic
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -j$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;nproc&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;gef&quot;&gt;gef&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;wget&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -q&lt;&#x2F;span&gt;&lt;span&gt; https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;bata24&#x2F;gef&#x2F;dev&#x2F;install.sh&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -O- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; sh
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;qemu&quot;&gt;QEMU&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; apt install qemu-system qemu-system-common qemu-utils
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;pasuhenozhui-jia&quot;&gt;パスへの追加&lt;&#x2F;h3&gt;
&lt;p&gt;bashrcに以下を追加&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;PATH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;PATH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;:&#x2F;path&#x2F;to&#x2F;lysithea&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;PATH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;quot;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffffff;&quot;&gt;PATH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;:&#x2F;path&#x2F;to&#x2F;vermagic&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;wen-ti-wojie-ku&quot;&gt;問題を解く&lt;&#x2F;h2&gt;
&lt;p&gt;一般に以下のファイルが提供される&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;bzImage&lt;&#x2F;code&gt;: カーネル&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;rootfs.cpio&lt;&#x2F;code&gt; or &lt;code&gt;initramfs.cpio&lt;&#x2F;code&gt;: rootファイルシステム&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;[name].ko&lt;&#x2F;code&gt;: カーネルオブジェクト&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;run.sh&lt;&#x2F;code&gt;: 実行するためのシェルスクリプト&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;追加でこれらのファイルが提供されていると嬉しい&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.config&lt;&#x2F;code&gt;: ビルドコンフィグ&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;[name].c&lt;&#x2F;code&gt;: カーネルオブジェクトのソースコード&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;deirekutorinochu-qi-hua&quot;&gt;ディレクトリの初期化&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#8be9fd;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;path&#x2F;to&#x2F;ctf
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;lysithea&lt;&#x2F;span&gt;&lt;span&gt; init
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;lysithea&lt;&#x2F;span&gt;&lt;span&gt; extract
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;extract&lt;&#x2F;code&gt;ディレクトリにrootfsの内容が展開される。まずはデバッグようにルートでシェルを得られるようにする&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;grep&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -r &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;setsid cttyhack setuidgid &amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; extracted
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;を実行し出てきたファイルがCTF用の初期化ファイルである。そのファイルの中身を以下のように書き換える&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;diff&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-diff &quot;&gt;&lt;code class=&quot;language-diff&quot; data-lang=&quot;diff&quot;&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;- setsid cttyhack setuidgid 9999 sh
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ setsid cttyhack setuidgid 0 sh
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;- echo 2 &amp;gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;kptr_restrict
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ echo 0 &amp;gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;kptr_restrict
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;- echo 1 &amp;gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;dmesg_restrict
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ echo 0 &amp;gt;&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;dmesg_restrict
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;kaslrnowu-xiao-hua&quot;&gt;KASLRの無効化&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;run.sh.dev&lt;&#x2F;code&gt;を以下のように変更&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;diff&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-diff &quot;&gt;&lt;code class=&quot;language-diff&quot; data-lang=&quot;diff&quot;&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;- -kernel .&#x2F;bzImage
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ -kernel .&#x2F;bzImage.own
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;- -append &amp;quot;console=ttyS0 kaslr quiet
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ -append &amp;quot;console=ttyS0 nokaslr verbose
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;+ -s
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;shi-xing&quot;&gt;実行&lt;&#x2F;h3&gt;
&lt;p&gt;以下のコマンドが&lt;code&gt;exploit&lt;&#x2F;code&gt;のコンパイルと便利ファイルの追加をした上で、&lt;code&gt;extracted&lt;&#x2F;code&gt;の圧縮を行い、&lt;code&gt;run.sh.dev&lt;&#x2F;code&gt;を実行してくれる&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;lysithea&lt;&#x2F;span&gt;&lt;span&gt; local
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;ここで、別タブでgdbを起動してアタッチするとカーネルの動きが追える&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;sudo&lt;&#x2F;span&gt;&lt;span&gt; gdb vmlinux.own
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;gef&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; target remote:1234
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;gef&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; directory &#x2F;path&#x2F;to&#x2F;linux &lt;&#x2F;span&gt;&lt;span style=&quot;color:#6272a4;&quot;&gt;# ソースコードの表示
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;image&#x2F;build_result.png&quot; alt=&quot;image&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;toraburusiyuteingu&quot;&gt;トラブルシューティング&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;invalid-module-formattoiueragachu-tachang-he&quot;&gt;&lt;code&gt;Invalid module format&lt;&#x2F;code&gt;というエラーが出た場合&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;linux&#x2F;include&#x2F;linux&#x2F;vermagic.h&lt;&#x2F;code&gt;を確認して必要なビルドオプションをつけて再度ビルドする&lt;&#x2F;p&gt;
&lt;h4 id=&quot;li&quot;&gt;例:&lt;&#x2F;h4&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#282a36;color:#f8f8f2;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;strings &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span&gt;chal&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;]&lt;&#x2F;span&gt;&lt;span&gt;.ko &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff79c6;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#50fa7b;&quot;&gt;grep&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#ffb86c;&quot;&gt; -E &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f1fa8c;&quot;&gt;&amp;#39;[0-9]+\.[0-9]+\.[0-9]+&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;を実行して、&lt;code&gt;6.6.58 SMP preempt mod_unload&lt;&#x2F;code&gt;が出てきたとする&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;CONFIG_SMP=y&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_PREEMPT_BUILD=y&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_MODULE_UNLOAD=y&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;CONFIG_MODVERSIONS=n&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;RANDSTRUCT_NONE=y&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;上記のコンフィグを設定してカーネルを再度ビルド&lt;&#x2F;p&gt;
&lt;h2 id=&quot;can-kao-wen-xian&quot;&gt;参考文献&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;p3land.smallkirby.com&#x2F;kernel&#x2F;&quot;&gt;p3land (セクキャンの講義資料)&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hackmd.io&#x2F;@bata24&#x2F;ryWzOHEMw&quot;&gt;qemu 各種アーキ環境構築&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hackmd.io&#x2F;@t3mp&#x2F;H1jTrjTp2&quot;&gt;Linux Kernel Debug Enviroment with buildroot&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</content>
        
    </entry>
</feed>
